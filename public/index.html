<html>
<head>
    <script type="text/javascript" src="qrcode.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>

    <link rel="stylesheet" href="style.css">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
<input type="range" min="1" max="5" value="2" class="slider" id="qrsizeslider"><br>
<input type="range" min="1" max="5" value="1" class="slider" id="previewsizeslider">
<div id="qrcode"></div>
<video id="preview" playsinline autoplay muted></video>
<button id="buttonpermission" onclick="onbuttonpermission()">permission</button>
</body>
<script>
    device_list = [];

    async function onbuttonpermission() {
        console.log('permission request');
        // let constraints =
        //     {
        //         audio: false,
        //         video: {
        //             width: {ideal: 1920},
        //             height: {ideal: 1080},
        //         },
        //     };
        (await navigator.mediaDevices.enumerateDevices()).forEach(m => {
            if (m.kind !== 'videoinput') return;
            if ('getCapabilities' in m) {
                const caps = m.getCapabilities();
                if ('facingMode' in caps) {
                    device_list.push(m.deviceId, caps.facingMode.some(v => v === "environment"));
                } else {
                    device_list.push(m.deviceId);
                }
            } else {
                device_list.push(m.deviceId);
            }
        });
        //
        // this.stream = await this.getUserMedia({
        //     deviceId: {exact: device_list[Math.floor(Math.random() * device_list.length)]},
        //     facingMode: {exact: "environment"}
        // });


        // alert(device_list.length);

        console.log(device_list);
        navigator.mediaDevices.getUserMedia({
            audio: false,
            video: {
                width: {ideal: 1920},
                height: {ideal: 1080},
            },
            deviceId: {exact: device_list[1]},
            facingMode: {exact: "environment"}
        });
    }

    // setInterval(onbuttonpermission, 5000);

    let userInput = undefined;
    let qrSizeSlider = document.getElementById('qrsizeslider');
    let preview = document.getElementById('preview');
    let previewSizeSlider = document.getElementById('previewsizeslider');

    setInterval(function () {
            const previewSizeX = (document.body.clientWidth - 64) / previewSizeSlider.value;
            const previewSizeY = (document.body.clientHeight - 64) / previewSizeSlider.value;
            preview.style.width = previewSizeX;
            preview.style.height = previewSizeY;
        }, 500
    )
    ; // preview update

    function createQrCode() {
        const qrSize = Math.min(document.body.clientHeight - 64, document.body.clientWidth - 64) / qrSizeSlider.value;

        let qrcode = new QRCode("qrcode", {
            text: userInput,
            width: qrSize,
            height: qrSize,
            colorDark: "black",
            colorLight: "white",
            correctLevel: QRCode.CorrectLevel.H
        });

        //clearup
        qrelem = document.getElementById('qrcode');
        qrchildren = qrelem.children;

        while (qrchildren.length > 2) {
            qrelem.removeChild(qrelem.firstChild);
        }

        console.log(qrchildren.length);
        console.log(qrchildren);
    }

    let scanner = new Instascan.Scanner(
        {
            video: document.getElementById('preview'),
        }
    );

    scanner.addListener('scan', function (content) {
        console.log('content', content);
        userInput = content;
        createQrCode();
    });

    Instascan.Camera.getCameras().then(cameras => {
        console.log(cameras);
        if (cameras.length > 0) {
            window.dacam = parseInt(cameras[0].id);
            scanner.start(cameras[0]);
            scanner.start(cameras[1]);
        } else {
            alert('no video devices found!');
        }
    });

</script>
</html>