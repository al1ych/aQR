<html>
<head>
    <script type="text/javascript" src="qrcode.js"></script>
    <script src="camera.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="style.css">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
<input type="range" min="1" max="5" value="2" class="slider" id="qrsizeslider"><br>
<input type="range" min="1" max="5" value="2" class="slider" id="previewsizeslider">
<video id="preview" playsinline autoplay muted></video>
<br>
<div id="qrcode"></div>
<button id="button" onclick="funk()">switch camera</button>
</body>
<script>
    let userInput = undefined;
    let qrSizeSlider = document.getElementById('qrsizeslider');
    let preview = document.getElementById('preview');
    let previewSizeSlider = document.getElementById('previewsizeslider');

    let scanner = new Instascan.Scanner(
        {
            video: document.getElementById('preview'),
            mirror: false,
        }
    );

    setTimeout(function () {
        funk();
    }, 1800);

    window.onload = funk;

    function funk() {
        const camera = new Camera();
        setTimeout(function () {
            camera.open_next();
            camera.on("open", function (stream) {
                console.log("Got camera. Showing it");
                preview.srcObject = stream;
            });
            camera.on("error", function (where, err) {
                console.log(where, err);
            });

        }, 1000);
    }


    setInterval(function () {
        const previewSizeX = (document.body.clientWidth - 64) / previewSizeSlider.value;
        const previewSizeY = (document.body.clientHeight - 64) / previewSizeSlider.value;
        preview.style.width = previewSizeX;
        preview.style.height = previewSizeY;

        $.ajax({
            type: 'GET',
            url: '/link_down',
            success: (d) => {
                console.log('link down', d);
                if (d !== undefined && d !== 'undefined')
                {
                    userInput = d;
                }
            }
        });
    }, 100);

    function createQrCode() {
        const qrSize = Math.min(document.body.clientHeight - 64, document.body.clientWidth - 64) / qrSizeSlider.value;
        let qrcode = new QRCode("qrcode", {
            text: userInput,
            width: qrSize,
            height: qrSize,
            colorDark: "black",
            colorLight: "white",
            correctLevel: QRCode.CorrectLevel.H
        });
        //clearup
        qrelem = document.getElementById('qrcode');
        qrchildren = qrelem.children;
        while (qrchildren.length > 2) {
            qrelem.removeChild(qrelem.firstChild);
        }
        console.log(qrchildren.length);
        console.log(qrchildren);
    }


    scanner.addListener('scan', function (content) {
        console.log('content', content);
        userInput = content;
        $.ajax({
            type: 'POST',
            url: '/link_up',
            data: {
                link: content
            }
        });
        createQrCode();
    });

    Instascan.Camera.getCameras().then(cameras => {
        console.log(cameras);
        if (cameras.length > 0) {
            // window.dacam = parseInt(cameras[0].id);
            // console.log('cameras id', cameras[0].id);
            scanner.start(cameras[0]);
            // scanner.start(cameras[1]);
        } else {
            alert('no video devices found!');
        }
    });

</script>
</html>