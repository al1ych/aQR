<html>
<head>
    <script type="text/javascript" src="qrcode.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>
<input type="range" min="1" max="5" value="2" class="slider" id="qrsizeslider"><br>
<input type="range" min="1" max="5" value="1" class="slider" id="previewsizeslider">
<div id="qrcode"></div>
<video id="preview" autoplay playsinline></video>
<!--<button id="buttonpermission" onclick="onbuttonpermission()">permission</button>-->
</body>
<script>
    function onbuttonpermission() {
        console.log('permission request');
        constraints =
            {
                audio: false,
                video: {facingMode: {exact: "environment"}},
                facingMode: {exact: "environment"}
            };

        navigator.mediaDevices.getUserMedia(constraints);
    }

    let userInput = undefined;
    let qrSizeSlider = document.getElementById('qrsizeslider');
    let preview = document.getElementById('preview');
    let previewSizeSlider = document.getElementById('previewsizeslider');

    setInterval(function () {
            const previewSizeX = (document.body.clientWidth - 64) / previewSizeSlider.value;
            const previewSizeY = (document.body.clientHeight - 64) / previewSizeSlider.value;
            preview.style.width = previewSizeX;
            preview.style.height = previewSizeY;
        }, 1000
    )
    ; // preview update

    function createQrCode() {
        const qrSize = Math.min(document.body.clientHeight - 64, document.body.clientWidth - 64) / qrSizeSlider.value;

        let qrcode = new QRCode("qrcode", {
            text: userInput,
            width: qrSize,
            height: qrSize,
            colorDark: "black",
            colorLight: "white",
            correctLevel: QRCode.CorrectLevel.H
        });

        //clearup
        qrelem = document.getElementById('qrcode');
        qrchildren = qrelem.children;

        while (qrchildren.length > 2) {
            qrelem.removeChild(qrelem.firstChild);
        }

        console.log(qrchildren.length);
        console.log(qrchildren);
    }

    let scanner;
    window.onload = function() {
         scanner = new Instascan.Scanner(
            {
                // video: document.getElementById('preview'),
                video: window.camera,
            }
        );

        scanner.addListener('scan', function (content) {
            console.log('content', content);
            userInput = content;
            createQrCode();
        });
    }
    Instascan.Camera.getCameras().then(cameras => {
        if (cameras.length > 0) {
            console.log('cameras', cameras);
            window.camera = cameras[cameras.length - 1];
            // scanner.start(cameras[0]);
        } else {
            console.error("No existe camer o dispositivo!");
        }
    });

</script>
</html>